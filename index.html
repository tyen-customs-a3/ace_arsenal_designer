<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACE3 Arsenal Simulation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    
    <div class="arsenal-container">
        <!-- Compact Category Sidebar -->
        <div class="category-sidebar">
            <button class="category-tab active" data-category="weapons" data-tooltip="Primary Weapons">🔫</button>
            <button class="category-tab" data-category="handguns" data-tooltip="Handguns">🔫</button>
            <button class="category-tab" data-category="launchers" data-tooltip="Launchers">🚀</button>
            <button class="category-tab" data-category="backpacks" data-tooltip="Backpacks">🎒</button>
            <button class="category-tab" data-category="vests" data-tooltip="Vests">🎽</button>
        </div>

        <!-- Left Panel - Equipment List -->
        <div class="left-panel">
            <div class="left-panel-header">
                <span class="header-title">Equipment List</span>
                <div class="header-controls">
                    <input type="text" class="header-search" id="leftSearch" placeholder="Search...">
                </div>
            </div>
            
            <div class="grouping-controls">
                
                <!-- Grouping Controls - Property-Based Organization -->
                <div class="control-group">
                    <label class="control-label">Group by:</label>
                    <select id="primaryGrouping">
                        <option value="none">None</option>
                        <option value="groupByMod">Mod</option>
                        <option value="groupByCaliber">Caliber</option>
                    </select>
                    <div class="sort-control-group">
                        <label class="control-label">Sort by:</label>
                        <select id="sortingSelect">
                            <option value="sortByName">Name</option>
                            <option value="sortByMod">Mod</option>
                            <option value="sortByRange">Range</option>
                            <option value="sortByMass">Mass</option>
                        </select>
                        <button class="sort-order-toggle" id="sortOrderToggle" onclick="toggleSortOrder()" title="Toggle sort order">↑</button>
                    </div>
                </div>
                
            </div>
            
            <!-- Tree Controls outside and above list -->
            <div class="tree-controls-external">
                <button class="tree-toggle-btn" id="treeToggleBtn" onclick="toggleExpandCollapse()">▶</button>
                <span class="tree-toggle-text" id="treeToggleText">Expand All</span>
                
                <!-- View Options moved from filters -->
                <div class="view-options-inline">
                    <div class="view-mode-toggles">
                        <button class="view-mode-toggle" data-view="list" title="Flat List">📄</button>
                        <button class="view-mode-toggle" data-view="hierarchy" title="Inheritance Tree">🌳</button>
                        <button class="view-mode-toggle active" data-view="variants" title="Variants">🎨</button>
                    </div>
                </div>
            </div>
            
            <div class="left-content">
                <ul class="tree-view" id="leftTreeView">
                    <!-- Category items will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Vertical Panel Container -->
        <div class="side-panels-container">
            <!-- Compact Filter Panel -->
            <div class="compact-filter-panel" id="compactFilterPanel">
                <!-- Filter toggle header -->
                <div class="filter-toggle-header" onclick="toggleFilterPanel()">
                    <span class="filter-toggle-text">Filters</span>
                    <span class="filter-toggle-arrow" id="filterToggleArrow">▶</span>
                </div>
                
                <!-- Filter content -->
                <div class="filter-content" id="filterContent">
                    <!-- Compact Filter Groups -->
                    <div class="compact-filter-group">
                        <label class="compact-filter-label">Mod:</label>
                        <div class="compact-filter-checkboxes" id="modFilters">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="compact-filter-group">
                        <label class="compact-filter-label">Caliber:</label>
                        <div class="compact-filter-checkboxes" id="caliberFilters">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="compact-filter-group">
                        <label class="compact-filter-label">Variants:</label>
                        <div class="compact-filter-radios">
                            <label class="compact-filter-option">
                                <input type="radio" name="variantFilter" value="all" checked>
                                <span>All</span>
                            </label>
                            <label class="compact-filter-option">
                                <input type="radio" name="variantFilter" value="base-only">
                                <span>Base</span>
                            </label>
                            <label class="compact-filter-option">
                                <input type="radio" name="variantFilter" value="variants-only">
                                <span>Variants</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="clear-filters-btn" onclick="clearAllFilters()" title="Clear all filters">Clear All Filters</button>
                </div>
            </div>

            <!-- Compact Stats Panel -->
            <div class="compact-stats-panel" id="compactStatsPanel">
                <!-- Stats toggle header -->
                <div class="filter-toggle-header" onclick="toggleStatsPanel()">
                    <span class="filter-toggle-text">Statistics</span>
                    <span class="filter-toggle-arrow" id="statsToggleArrow">▶</span>
                </div>
                
                <!-- Stats content -->
                <div class="filter-content" id="statsContent">
                    <div class="stat-item">
                        <span class="stat-label">Damage:</span>
                        <span class="stat-value" id="statDamage">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Range:</span>
                        <span class="stat-value" id="statRange">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Mass:</span>
                        <span class="stat-value" id="statMass">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Capacity:</span>
                        <span class="stat-value" id="statCapacity">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Mod Source:</span>
                        <span class="stat-value" id="statMod">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Selected Item Options -->
        <div class="right-panel">
            <div class="right-panel-header">
                <span class="header-title">Compatible Items</span>
                <div class="header-controls">
                    <input type="text" class="header-search" id="rightSearch" placeholder="Search...">
                </div>
            </div>
            <div class="right-content">
                <ul class="tree-view" id="rightTreeView">
                    <!-- Attachments and magazines will be populated here -->
                </ul>
            </div>
        </div>


        <!-- Attachment Category Sidebar -->
        <div class="attachment-sidebar">
            <button class="attachment-tab active" data-attachment="attachments" data-tooltip="Attachments">🔧</button>
            <button class="attachment-tab" data-attachment="magazines" data-tooltip="Magazines">📦</button>
        </div>

        <!-- Central Area - Empty space for UI layout -->
        <div class="central-area">
        </div>



        <div class="timing" id="timing">Ready</div>
    </div>

    <script type="module">
        // Import data and algorithms
        import { getMockItems } from './data.js';
        import * as algorithms from './algorithms.js';
        import * as groupingAlgorithms from './algorithms/grouping.js';
        import * as multiGrouping from './algorithms/multiGrouping.js';
        import * as hierarchyAlgorithms from './algorithms/hierarchy.js';
        
        // Import simple tree components  
        import { 
            createTreeData,
            renderSimpleTree,
            toggleTreeGroup,
            selectTreeItem,
            initializeKeyboardNavigation,
            clearPanelFocus,
            focusFirstItem
        } from './ui/simpleTree.js';
        
        // Global state - simplified
        let currentItems = [];
        let filteredItems = [];
        let selectedCategory = 'weapons';
        let selectedRightCategory = 'attachments';
        let selectedItem = null;
        let currentSortOrder = 'asc';
        let currentExpandState = false;

        // Filter state
        let activeFilters = {
            mods: new Set(),
            calibers: new Set(),
            variants: 'all',
        };

        // Category filtering
        function filterItemsByCategory(category) {
            const categoryItems = currentItems.filter(item => item.category === category);
            return applyActiveFilters(categoryItems);
        }

        // Apply all active filters to items
        function applyActiveFilters(items) {
            return items.filter(item => {
                // Mod filter
                if (activeFilters.mods.size > 0 && !activeFilters.mods.has(item.mod || 'Unknown')) {
                    return false;
                }

                // Caliber filter
                if (activeFilters.calibers.size > 0 && !activeFilters.calibers.has(item.caliber || 'Unknown')) {
                    return false;
                }

                // Variant filter
                if (activeFilters.variants === 'base-only' && item.variant) {
                    return false;
                }
                if (activeFilters.variants === 'variants-only' && !item.variant) {
                    return false;
                }

                return true;
            });
        }

        // Generate filter options dynamically based on current category
        function populateFilterOptions(category) {
            const categoryItems = currentItems.filter(item => item.category === category);
            
            // Get unique values for each filter type
            const mods = [...new Set(categoryItems.map(item => item.mod || 'Unknown'))].sort();
            const calibers = [...new Set(categoryItems.map(item => item.caliber).filter(c => c))].sort();

            // Populate mod filters
            const modContainer = document.getElementById('modFilters');
            modContainer.innerHTML = mods.map(mod => `
                <label class="filter-checkbox">
                    <input type="checkbox" value="${mod}" onchange="toggleFilter('mods', '${mod}', this.checked)">
                    <span>${mod}</span>
                </label>
            `).join('');

            // Populate caliber filters
            const caliberContainer = document.getElementById('caliberFilters');
            caliberContainer.innerHTML = calibers.map(caliber => `
                <label class="filter-checkbox">
                    <input type="checkbox" value="${caliber}" onchange="toggleFilter('calibers', '${caliber}', this.checked)">
                    <span>${caliber}</span>
                </label>
            `).join('');

        }

        // Toggle individual filter
        function toggleFilter(filterType, value, isChecked) {
            if (isChecked) {
                activeFilters[filterType].add(value);
            } else {
                activeFilters[filterType].delete(value);
            }
            updateFilteredItems();
        }

        // Clear all filters
        function clearAllFilters() {
            activeFilters.mods.clear();
            activeFilters.calibers.clear();
            activeFilters.variants = 'all';

            // Reset UI
            document.querySelectorAll('.compact-filter-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelector('input[name="variantFilter"][value="all"]').checked = true;

            updateFilteredItems();
        }

        // Update filtered items and refresh display
        function updateFilteredItems() {
            filteredItems = filterItemsByCategory(selectedCategory);
            renderTreeView(filteredItems, 'leftTreeView');
        }

        // Filter compatible accessories for selected weapon using weaponSlots
        function getCompatibleAccessories(weapon) {
            if (!weapon) return [];
            
            const attachments = currentItems.filter(item => item.category === 'attachments');
            console.log(`🔧 Found ${attachments.length} total attachments in currentItems`);
            
            // Filter attachments by weapon slot compatibility
            if (weapon.weaponSlots && weapon.weaponSlots.length > 0) {
                const compatible = attachments.filter(attachment => {
                    if (!attachment.weaponSlots || attachment.weaponSlots.length === 0) {
                        return false; // Attachment has no slot info, assume incompatible
                    }
                    
                    // Check if any weapon slot matches any attachment slot
                    return weapon.weaponSlots.some(weaponSlot => 
                        attachment.weaponSlots.some(attachmentSlot => 
                            weaponSlot === attachmentSlot
                        )
                    );
                });
                console.log(`🔧 Found ${compatible.length} compatible attachments:`, compatible.map(a => a.displayName));
                return compatible;
            }
            
            // If weapon has no slot info, show no attachments (strict compatibility)
            console.log('⚠️ Weapon has no weaponSlots defined, showing no attachments');
            return [];
        }

        // Filter compatible magazines for selected weapon using magazineWells
        function getCompatibleMagazines(weapon) {
            if (!weapon) return [];
            
            const magazines = currentItems.filter(item => item.category === 'magazines');
            console.log(`📦 Found ${magazines.length} total magazines in currentItems`);
            
            // Filter magazines by magazineWells compatibility
            if (weapon.magazineWells && weapon.magazineWells.length > 0) {
                const compatible = magazines.filter(magazine => {
                    if (!magazine.magazineWells || magazine.magazineWells.length === 0) {
                        return false; // Magazine has no well info, assume incompatible
                    }
                    
                    // Check if any weapon magazine well matches any magazine well
                    return weapon.magazineWells.some(weaponWell => 
                        magazine.magazineWells.some(magWell => 
                            weaponWell === magWell
                        )
                    );
                });
                console.log(`📦 Found ${compatible.length} compatible magazines:`, compatible.map(m => m.displayName));
                return compatible;
            }
            
            // If weapon has no magazine well info, show no magazines (strict compatibility)
            console.log('⚠️ Weapon has no magazineWells defined, showing no magazines');
            return [];
        }

        // Update right panel with compatible accessories
        function updateCompatibleAccessories(weapon) {
            console.log('🔫 Weapon selected:', weapon.displayName);
            console.log('📦 Magazine wells:', weapon.magazineWells);
            console.log('🔧 Weapon slots:', weapon.weaponSlots);
            console.log('🎯 Right panel category:', selectedRightCategory);
            
            if (selectedRightCategory === 'attachments') {
                const compatibleAttachments = getCompatibleAccessories(weapon);
                console.log('✅ Compatible attachments found:', compatibleAttachments.length);
                console.log('📋 Sample attachments:', compatibleAttachments.slice(0, 3).map(a => ({
                    name: a.displayName,
                    weaponSlots: a.weaponSlots,
                    subcategory: a.subcategory
                })));
                renderTreeView(compatibleAttachments, 'rightTreeView', false);
            } else if (selectedRightCategory === 'magazines') {
                const compatibleMagazines = getCompatibleMagazines(weapon);
                console.log('✅ Compatible magazines found:', compatibleMagazines.length);
                console.log('📋 Sample magazines:', compatibleMagazines.slice(0, 3).map(m => ({
                    name: m.displayName,
                    magazineWells: m.magazineWells,
                    caliber: m.caliber
                })));
                renderTreeView(compatibleMagazines, 'rightTreeView', false);
            }
        }


        // Simple tree view rendering
        function renderTreeView(items, containerId, useGrouping = true) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const startTime = performance.now();

            // Get current UI state
            const viewMode = document.querySelector('.view-mode-toggle.active')?.dataset.view || 'variants';
            const sortMethod = document.getElementById('sortingSelect').value;
            const sortOrder = currentSortOrder;
            const primaryGrouping = document.getElementById('primaryGrouping').value;

            let groupingFunction = null;
            let sortingFunction = null;

            // Get sorting function
            if (sortMethod && algorithms[sortMethod]) {
                sortingFunction = (items) => algorithms[sortMethod](items, sortOrder);
            }

            // Determine grouping and view mode
            // Priority: User grouping selection > View mode default behavior
            
            if (primaryGrouping !== 'none') {
                // User has selected a grouping - apply it as top-level grouping
                // View mode will be applied within each group
                useGrouping = true;
                groupingFunction = algorithms[primaryGrouping];
            } else {
                // No user grouping selected - let view mode handle all organization
                if (viewMode === 'variants' || viewMode === 'hierarchy') {
                    // Special view modes that handle their own organization
                    useGrouping = true;
                    groupingFunction = null; // No top-level grouping, let view mode handle everything
                } else {
                    // Flat list with no grouping
                    useGrouping = false;
                }
            }

            // Create tree data structure - view mode determines how items are displayed within groups
            const hasPrimaryGrouping = primaryGrouping !== 'none';
            const treeData = createTreeData(items, useGrouping, groupingFunction, sortingFunction, viewMode, hasPrimaryGrouping);
            
            // Render simple tree
            const html = `<ul class="tree-view">${renderSimpleTree(treeData)}</ul>`;
            
            const endTime = performance.now();
            document.getElementById('timing').textContent = `${(endTime - startTime).toFixed(2)}ms`;

            container.innerHTML = html;
            
            // Clear focus when tree content changes
            clearPanelFocus(containerId);
        }

        // Simple tree toggle - delegates to simpleTree.js
        function toggleTreeNodeExpansion(nodeId) {
            toggleTreeGroup(nodeId);
        }

        // Item selection and stats display
        function selectItem(element) {
            console.log('🖱️ Item clicked!', element);
            
            // Remove previous selection
            document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.tree-parent').forEach(item => item.classList.remove('selected'));
            element.classList.add('selected');

            try {
                selectedItem = JSON.parse(element.dataset.item);
                console.log('✅ Item parsed:', selectedItem.displayName, 'Category:', selectedItem.category);
                
                updateStats(selectedItem);
                
                
                // Update right panel with compatible accessories when weapon is selected
                if (selectedItem.category === 'weapons') {
                    console.log('🔫 Weapon detected, updating right panel...');
                    console.log('🔍 Current items total:', currentItems.length);
                    console.log('🔍 Items by category:', currentItems.reduce((acc, item) => {
                        acc[item.category] = (acc[item.category] || 0) + 1;
                        return acc;
                    }, {}));
                    updateCompatibleAccessories(selectedItem);
                } else {
                    console.log('🚫 Not a weapon, category:', selectedItem.category);
                }
            } catch (e) {
                console.warn('Could not parse item data:', e);
            }
        }

        function updateStats(item) {
            document.getElementById('statDamage').textContent = item.damage || '-';
            document.getElementById('statRange').textContent = item.range ? `${item.range}m` : '-';
            document.getElementById('statMass').textContent = item.mass ? `${(item.mass/1000).toFixed(2)}kg` : '-';
            document.getElementById('statCapacity').textContent = item.capacity || '-';
            
            // Enhanced mod display with inheritance info
            let modText = item.mod || '-';
            if (item.baseClass) {
                modText += ` (${item.baseClass})`;
            }
            if (item.variant) {
                modText += ` [${item.variant}]`;
            }
            document.getElementById('statMod').textContent = modText;
        }


        // Category tab handling
        function switchCategory(category) {
            selectedCategory = category;
            
            // Update tab appearance
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Populate filter options for new category
            populateFilterOptions(category);
            
            // Filter and display items
            filteredItems = filterItemsByCategory(category);
            renderTreeView(filteredItems, 'leftTreeView');
        }

        function switchRightCategory(category) {
            console.log('🔄 Switching right category to:', category);
            selectedRightCategory = category;
            
            // Update tab appearance
            document.querySelectorAll('.attachment-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-attachment="${category}"]`).classList.add('active');
            
            // Filter and display items based on selected weapon compatibility
            if (selectedItem && selectedItem.category === 'weapons') {
                console.log('🔫 Weapon is selected, filtering for compatibility...');
                updateCompatibleAccessories(selectedItem);
            } else {
                console.log('🔍 No weapon selected, showing all', category);
                // If no weapon selected, show all items of this category
                const rightItems = filterItemsByCategory(category);
                console.log('📦 Right items found:', rightItems.length);
                renderTreeView(rightItems, 'rightTreeView', false); // No grouping for right panel
            }
        }


        // Data generation
        function regenerateData() {
            currentItems = generateMockItems(200);
            switchCategory(selectedCategory);
            switchRightCategory(selectedRightCategory);
            clearSelection();
        }

        // New UI control functions
        function applySorting(items, method, order) {
            const sortFunction = algorithms[method];
            if (sortFunction) {
                return sortFunction(items, order);
            }
            return items;
        }
        
        function applyMultiGrouping(items, primary, secondary) {
            // Convert string names to actual grouping functions
            const primaryFunction = algorithms[primary];
            const secondaryFunction = getSecondaryGroupingFunction(secondary);
            
            if (primaryFunction && secondaryFunction) {
                return multiGrouping.groupByMultiple(items, primaryFunction, secondaryFunction);
            } else if (primaryFunction) {
                return primaryFunction(items);
            }
            
            return { 'All Items': items };
        }
        
        function getSecondaryGroupingFunction(secondaryName) {
            const mapping = {
                'groupByMod': algorithms.groupByMod,
                'groupByCaliber': algorithms.groupByCaliber
            };
            return mapping[secondaryName] || null;
        }
        
        function toggleInheritanceView() {
            // Toggle between flat list and inheritance hierarchy
            const currentView = document.querySelector('.view-mode-toggle.active')?.dataset.view;
            if (currentView === 'list') {
                setViewMode('hierarchy');
            } else {
                setViewMode('list');
            }
        }
        
        function setViewMode(mode) {
            // Remove active class from all view mode toggles
            document.querySelectorAll('.view-mode-toggle').forEach(btn => btn.classList.remove('active'));
            // Add active class to selected mode
            document.querySelector(`[data-view="${mode}"]`).classList.add('active');
            
            // Show/hide collapse toggle based on view mode
            const collapseToggleContainer = document.getElementById('treeToggleBtn').parentElement;
            const collapseToggleBtn = document.getElementById('treeToggleBtn');
            const collapseToggleText = document.getElementById('treeToggleText');
            
            if (mode === 'list') {
                // Hide collapse toggle for flat list view
                collapseToggleBtn.style.display = 'none';
                collapseToggleText.style.display = 'none';
            } else {
                // Show collapse toggle for hierarchy and variants views
                collapseToggleBtn.style.display = 'flex';
                collapseToggleText.style.display = 'inline';
            }
            
            renderTreeView(filteredItems, 'leftTreeView');
        }

        function runGrouping() {
            renderTreeView(filteredItems, 'leftTreeView');
        }

        function clearSelection() {
            // Clear visual selection
            document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.tree-parent').forEach(item => item.classList.remove('selected'));
            
            // Clear selected item
            selectedItem = null;
            
            // Clear stats
            ['statDamage', 'statRange', 'statMass', 'statCapacity', 'statMod'].forEach(id => {
                document.getElementById(id).textContent = '-';
            });

            // Clear loadout
            currentLoadout = { weapon: null, handgun: null, backpack: null, vest: null, attachments: [] };
            document.getElementById('previewWeapon').textContent = 'Primary: None';
            document.getElementById('previewHandgun').textContent = 'Handgun: None';
            document.getElementById('previewBackpack').textContent = 'Backpack: None';
            document.getElementById('previewVest').textContent = 'Vest: None';
            document.getElementById('previewAttachments').textContent = 'Attachments: None';
            
            // Reset right panel to show all items of current category
            const rightItems = filterItemsByCategory(selectedRightCategory);
            renderTreeView(rightItems, 'rightTreeView', false);
        }

        // Simple expand/collapse all
        function expandAllGroups() {
            document.querySelectorAll('.tree-children').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.tree-toggle').forEach(el => {
                el.textContent = '▼';
            });
        }

        function collapseAllGroups() {
            document.querySelectorAll('.tree-children').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.tree-toggle').forEach(el => {
                el.textContent = '▶';
            });
        }

        // New compact toggle functions
        function toggleSortOrder() {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            const button = document.getElementById('sortOrderToggle');
            button.textContent = currentSortOrder === 'asc' ? '↑' : '↓';
            button.title = currentSortOrder === 'asc' ? 'Ascending order - click for descending' : 'Descending order - click for ascending';
            renderTreeView(filteredItems, 'leftTreeView');
        }

        function toggleExpandCollapse() {
            const button = document.getElementById('treeToggleBtn');
            const text = document.getElementById('treeToggleText');
            if (currentExpandState) {
                collapseAllGroups();
                button.textContent = '▶';
                text.textContent = 'Expand All';
                currentExpandState = false;
            } else {
                expandAllGroups();
                button.textContent = '▼';
                text.textContent = 'Collapse All';
                currentExpandState = true;
            }
        }

        function toggleFilterPanel() {
            const panel = document.getElementById('compactFilterPanel');
            const content = document.getElementById('filterContent');
            const arrow = document.getElementById('filterToggleArrow');
            
            panel.classList.toggle('expanded');
            
            if (panel.classList.contains('expanded')) {
                content.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▶';
            }
        }

        function toggleStatsPanel() {
            const panel = document.getElementById('compactStatsPanel');
            const content = document.getElementById('statsContent');
            const arrow = document.getElementById('statsToggleArrow');
            
            panel.classList.toggle('expanded');
            
            if (panel.classList.contains('expanded')) {
                content.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▶';
            }
        }

        // Global functions for buttons and tree interaction
        window.regenerateData = regenerateData;
        window.runGrouping = runGrouping;
        window.clearSelection = clearSelection;
        window.selectItem = selectItem;
        window.toggleTreeGroup = toggleTreeGroup;
        window.selectTreeItem = selectTreeItem;
        window.toggleInheritanceView = toggleInheritanceView;
        window.setViewMode = setViewMode;
        window.expandAllGroups = expandAllGroups;
        window.collapseAllGroups = collapseAllGroups;
        window.toggleFilter = toggleFilter;
        window.clearAllFilters = clearAllFilters;
        window.toggleSortOrder = toggleSortOrder;
        window.toggleExpandCollapse = toggleExpandCollapse;
        window.toggleFilterPanel = toggleFilterPanel;
        window.toggleStatsPanel = toggleStatsPanel;

        // Event listeners for new UI controls
        document.getElementById('sortingSelect').addEventListener('change', (e) => {
            renderTreeView(filteredItems, 'leftTreeView');
        });
        
        
        document.getElementById('primaryGrouping').addEventListener('change', (e) => {
            renderTreeView(filteredItems, 'leftTreeView');
        });
        
        
        // View mode toggle button listeners
        document.querySelectorAll('.view-mode-toggle').forEach(button => {
            button.addEventListener('click', (e) => {
                const mode = e.target.dataset.view;
                setViewMode(mode);
            });
        });

        // Variant filter radio button listeners
        document.querySelectorAll('input[name="variantFilter"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                activeFilters.variants = e.target.value;
                updateFilteredItems();
            });
        });
        
        // Category tab listeners
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => switchCategory(tab.dataset.category));
        });

        // Right panel tab listeners
        document.querySelectorAll('.attachment-tab').forEach(tab => {
            tab.addEventListener('click', () => switchRightCategory(tab.dataset.attachment));
        });

        // Search functionality
        document.getElementById('leftSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const baseItems = filterItemsByCategory(selectedCategory);
            const items = baseItems.filter(item => item.displayName.toLowerCase().includes(searchTerm));
            renderTreeView(items, 'leftTreeView');
        });

        document.getElementById('rightSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const items = filterItemsByCategory(selectedRightCategory)
                .filter(item => item.displayName.toLowerCase().includes(searchTerm));
            renderTreeView(items, 'rightTreeView', false);
        });

        // Async initialization function
        async function initializeArsenal() {
            // Show loading message
            document.getElementById('timing').textContent = 'Loading data...';
            
            try {
                // Load data asynchronously
                const items = await getMockItems();
                currentItems = [...items];
                filteredItems = [...items];
                
                // Initialize UI state
                switchCategory('weapons');
                switchRightCategory('attachments');
                
                // Set initial expand state based on variant view default
                // Since variant view creates groups, they should start expanded
                currentExpandState = true;
                const button = document.getElementById('treeToggleBtn');
                const text = document.getElementById('treeToggleText');
                if (button && text) {
                    button.textContent = '▼';
                    text.textContent = 'Collapse All';
                }
                
                // Initialize toggle visibility for default variant view
                setViewMode('variants');
                
                // Initialize keyboard navigation for both panels
                initializeKeyboardNavigation('leftTreeView');
                initializeKeyboardNavigation('rightTreeView');

                console.log('🎯 ACE3 Arsenal Simulation Ready!');
                console.log('💡 Select a weapon to see compatible attachments and magazines.');
                console.log('📊 Items loaded:', {
                    weapons: currentItems.filter(i => i.category === 'weapons').length,
                    handguns: currentItems.filter(i => i.category === 'handguns').length,
                    launchers: currentItems.filter(i => i.category === 'launchers').length,
                    attachments: currentItems.filter(i => i.category === 'attachments').length,
                    magazines: currentItems.filter(i => i.category === 'magazines').length,
                    backpacks: currentItems.filter(i => i.category === 'backpacks').length,
                    vests: currentItems.filter(i => i.category === 'vests').length
                });
                
                // Debug: Check some sample items have the right data
                const sampleWeapon = currentItems.find(i => i.category === 'weapons');
                const sampleMagazine = currentItems.find(i => i.category === 'magazines');
                const sampleAttachment = currentItems.find(i => i.category === 'attachments');
                
                console.log('🔫 Sample weapon:', sampleWeapon?.displayName, 'magazineWells:', sampleWeapon?.magazineWells, 'weaponSlots:', sampleWeapon?.weaponSlots);
                console.log('📦 Sample magazine:', sampleMagazine?.displayName, 'magazineWells:', sampleMagazine?.magazineWells);
                console.log('🔧 Sample attachment:', sampleAttachment?.displayName, 'weaponSlots:', sampleAttachment?.weaponSlots);
                
                // Debug: Check all magazines for magazineWells data
                const allMagazines = currentItems.filter(i => i.category === 'magazines');
                console.log('📦 Total magazines:', allMagazines.length);
                console.log('📦 Magazines with magazineWells:', allMagazines.filter(m => m.magazineWells && m.magazineWells.length > 0).length);
                console.log('📦 Sample magazine data:', allMagazines.slice(0, 3).map(m => ({
                    name: m.displayName,
                    magazineWells: m.magazineWells,
                    caliber: m.caliber
                })));
                
                document.getElementById('timing').textContent = 'Ready';
                
            } catch (error) {
                console.error('🚨 Failed to load arsenal data:', error);
                
                // Show user-friendly error message
                const timing = document.getElementById('timing');
                timing.textContent = 'Error loading data';
                timing.style.color = '#ff4444';
                timing.style.cursor = 'pointer';
                timing.title = `Click for details: ${error.message}`;
                
                // Show error in left panel
                const leftTreeView = document.getElementById('leftTreeView');
                if (leftTreeView) {
                    leftTreeView.innerHTML = `
                        <div style="padding: 20px; color: #ff4444; text-align: center;">
                            <h3>⚠️ Data Loading Error</h3>
                            <p style="margin: 10px 0; font-size: 12px;">${error.message}</p>
                            <p style="font-size: 10px; color: #999;">Check browser console for details</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 10px; background: #333; color: #fff; border: 1px solid #666; border-radius: 3px; cursor: pointer;">
                                Reload Page
                            </button>
                        </div>
                    `;
                }
                
                // Optional: Show error details on click
                timing.onclick = () => {
                    alert(`Arsenal Loading Error:\n\n${error.message}\n\nCheck the browser console (F12) for more details.`);
                };
            }
        }
        
        // Initialize the application
        initializeArsenal();

    </script>
</body>
</html>