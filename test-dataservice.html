<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataService Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-entry.error { color: #dc3545; }
        .log-entry.warn { color: #ffc107; }
        .log-entry.info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DataService Test</h1>
        <p>This page tests the DataService parallel parsing functionality.</p>
        
        <div class="controls">
            <button id="initBtn">Initialize DataService</button>
            <button id="resetBtn">Reset Service</button>
            <button id="statsBtn">Show Stats</button>
        </div>
        
        <div id="status" class="status info">Ready to test</div>
        
        <div class="stats" id="stats"></div>
        
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { DataService } from './services/DataService.js';

        const dataService = new DataService({ maxWorkers: 2, workerTimeout: 15000 });
        
        const statusEl = document.getElementById('status');
        const statsEl = document.getElementById('stats');
        const logEl = document.getElementById('log');
        const initBtn = document.getElementById('initBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statsBtn = document.getElementById('statsBtn');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function showStats() {
            const stats = dataService.getStats();
            
            statsEl.innerHTML = Object.entries(stats).map(([key, value]) => `
                <div class="stat-card">
                    <div class="stat-value">${value}</div>
                    <div class="stat-label">${key.replace(/([A-Z])/g, ' $1').toLowerCase()}</div>
                </div>
            `).join('');
        }

        initBtn.addEventListener('click', async () => {
            try {
                initBtn.disabled = true;
                updateStatus('Initializing DataService...', 'info');
                log('Starting DataService initialization...');
                
                const startTime = performance.now();
                const data = await dataService.initialize();
                const endTime = performance.now();
                
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                const classCount = Object.keys(data).length;
                
                updateStatus(`✅ DataService initialized successfully! Aggregated ${classCount} classes in ${duration}s`, 'success');
                log(`DataService initialization completed in ${duration} seconds`);
                log(`Successfully aggregated ${classCount} top-level classes from all config files`);
                
                // Log a sample of the aggregated data structure
                const topLevelClasses = Object.keys(data).slice(0, 5);
                log(`Sample top-level classes: ${topLevelClasses.join(', ')}`);
                
                // Verify the structure is correct (not file-path-keyed)
                const firstClassName = Object.keys(data)[0];
                if (firstClassName && data[firstClassName].className && data[firstClassName]._sourceMod) {
                    log(`✅ Structure validation passed - classes have metadata: ${firstClassName} from ${data[firstClassName]._sourceMod}`);
                } else {
                    log(`⚠️ Structure validation warning - unexpected format for class: ${firstClassName}`, 'warn');
                }
                
                showStats();
                
            } catch (error) {
                updateStatus(`❌ DataService initialization failed: ${error.message}`, 'error');
                log(`DataService initialization failed: ${error.message}`, 'error');
                console.error('DataService error:', error);
            } finally {
                initBtn.disabled = false;
            }
        });

        resetBtn.addEventListener('click', () => {
            dataService.reset();
            updateStatus('DataService reset', 'info');
            log('DataService has been reset');
            statsEl.innerHTML = '';
            showStats();
        });

        statsBtn.addEventListener('click', () => {
            showStats();
            log('Stats updated');
        });

        // Initial stats display
        showStats();
        
        // Intercept console messages to display in log
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = (...args) => {
            originalConsoleLog.apply(console, args);
            log(args.join(' '), 'info');
        };
        
        console.error = (...args) => {
            originalConsoleError.apply(console, args);
            log(args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            originalConsoleWarn.apply(console, args);
            log(args.join(' '), 'warn');
        };
    </script>
</body>
</html>